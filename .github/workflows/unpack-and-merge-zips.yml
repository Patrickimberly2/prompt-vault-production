name: Unpack and merge zips

on:
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  unpack_and_merge:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Install unzip
        run: sudo apt-get update && sudo apt-get install -y unzip

      - name: Create branch name
        run: |
          echo "BRANCH=merge/unpack-zips-$(date +%s)" >> $GITHUB_ENV
          echo "Created branch $BRANCH"

      - name: Create and switch to branch (robust)
        run: |
          set -e
          git fetch origin main
          # Use -B to (re)create or reset the branch locally
          git checkout -B "$BRANCH"

      - name: Unpack PromptVault_2.0_Scripts.zip if present
        run: |
          if [ -f PromptVault_2.0_Scripts.zip ]; then
            mkdir -p PromptVault_2.0_Scripts
            unzip -o PromptVault_2.0_Scripts.zip -d PromptVault_2.0_Scripts
            echo "Unzipped PromptVault_2.0_Scripts.zip"
          else
            echo "PromptVault_2.0_Scripts.zip not found; skipping"
          fi

      - name: Unpack PromptVault_Migration_Complete.zip if present
        run: |
          if [ -f PromptVault_Migration_Complete.zip ]; then
            mkdir -p PromptVault_Migration_Complete
            unzip -o PromptVault_Migration_Complete.zip -d PromptVault_Migration_Complete
            echo "Unzipped PromptVault_Migration_Complete.zip"
          else
            echo "PromptVault_Migration_Complete.zip not found; skipping"
          fi

      - name: Debug: show git status before commit
        run: |
          git status --porcelain
          git ls-files --others --exclude-standard || true

      - name: Configure git user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --list

      - name: Stage and commit any changes
        run: |
          set -e
          git add PromptVault_2.0_Scripts PromptVault_Migration_Complete || true
          echo "Staged files:"
          git status --porcelain
          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          git commit -m "Unpack zip archives into repository"

      - name: Push branch
        run: |
          set -e
          # push and set upstream
          git push --set-upstream origin "$BRANCH"

      - name: Create pull request
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const branch = process.env.BRANCH;
            const pr = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: "Unpack zip archives into repository",
              head: branch,
              base: "main",
              body: "This PR unpacks PromptVault_2.0_Scripts.zip and PromptVault_Migration_Complete.zip into folders for review."
            });
            console.log("PR created: " + pr.data.html_url)
